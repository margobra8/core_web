<!doctype html><html lang=es><head><title>Sistema de puntuaciones :: CORE Study Hub</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="En este post se detalla como añadir la posibilidad de almacenar puntuaciones por cada grupo, y crear una página de puntuación para cada grupo"><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=/posts/sistema-de-puntuaciones/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://core.marquitos.space/"><meta name=twitter:creator content="usualmarcos"><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="og:title" content="Sistema de puntuaciones"><meta property="og:description" content="En este post se detalla como añadir la posibilidad de almacenar puntuaciones por cada grupo, y crear una página de puntuación para cada grupo"><meta property="og:url" content="/posts/sistema-de-puntuaciones/"><meta property="og:site_name" content="CORE Study Hub"><meta property="og:image" content="/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-05-31 19:04:17 +0200 +0200"></head><body class=green><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>CORE Study Hub</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/showcase>Showcase</a></li><li><a href=/about>Sobre mí</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/showcase>Showcase</a></li><li><a href=/about>Sobre mí</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/sistema-de-puntuaciones/>Sistema de puntuaciones</a></h1><div class=post-meta><span class=post-date>2021-05-31</span>
<span class=post-author>:: Marcos Gómez</span></div><span class=post-tags>#<a href=/tags/js/>js</a>&nbsp;
#<a href=/tags/html/>html</a>&nbsp;
#<a href=/tags/router/>router</a>&nbsp;
#<a href=/tags/routes/>routes</a>&nbsp;
#<a href=/tags/sequelize/>sequelize</a>&nbsp;
#<a href=/tags/models/>models</a>&nbsp;
#<a href=/tags/controllers/>controllers</a>&nbsp;
#<a href=/tags/views/>views</a>&nbsp;</span><div class=post-content><div><p>Cuando nos pidan implementar una funcionalidad nueva que se tenga que ver en una nueva &ldquo;página&rdquo; tendremos que tocar las rutas (<code>routes/index.js</code>), las vistas (<code>views/*</code>) e implementar una nueva funcionalidad en el controlador que toque (<code>controllers/*</code>) y en este caso los modelos (<code>models/*</code>).</p><p>A mí personalmente me gusta empezar por lo fácil, implementar la ruta o rutas.</p><h2 id=implementación-de-la-ruta>Implementación de la ruta<a href=#implementación-de-la-ruta class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Para implementar esta funcionalidad vamos a hacer que el usuario pueda visualizar la puntuación de los grupos en una nueva página. Para ello implementaremos una primitiva HTTP <code>GET /scores/</code> en la que se visualizará una tabla con todas las puntuaciones de todos los grupos. Para gestionar el tema de las puntuaciones crearemos un controlador que se encarge de gestionar todas las primitivas relacionadas con las puntuaciones.</p><p>De momento supondremos que este controller lo llamaremos <code>scoreController</code>. Vamos a editar el documento de rutas para incluir la nueva ruta.</p><div class=collapsable-code><input id=136285947 type=checkbox>
<label for=136285947><span class=collapsable-code__language>js</span>
<span class=collapsable-code__title>routes/index.js</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-js><code>
var express = require(&#34;express&#34;);
var router = express.Router();

const quizController = require(&#34;../controllers/quiz&#34;);
const userController = require(&#34;../controllers/user&#34;);
const sessionController = require(&#34;../controllers/session&#34;);
const groupController = require(&#34;../controllers/group&#34;);
// añadimos nuestro controlador que luego crearemos
const scoreController = require(&#34;../controllers/score&#34;);

[...]

// añadimos una nueva ruta al final del archivo para satisfacer nuestro objetivo
router.get(&#34;/scores&#34;, scoreController.index);
</code></pre></div><p>De esta manera, cuando el usuario haga un GET a esta ruta se pasará el control al middleware <code>index</code> de <code>scoreController</code> que ahora crearemos.</p><h1 id=modificación-del-modelo>Modificación del modelo<a href=#modificación-del-modelo class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Para acomodar las puntuaciones por grupo tenemos que modificar el modelo de <code>Group</code> añadiendo un campo de puntuación, eso lo haremos en el archivo del modelo correspondiente:</p><div class=collapsable-code><input id=532718649 type=checkbox>
<label for=532718649><span class=collapsable-code__language>js</span>
<span class=collapsable-code__title>routes/index.js</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-js><code>
const { Model } = require(&#34;sequelize&#34;);

// Definition of the Quiz model:

module.exports = (sequelize, DataTypes) =&gt; {
  class Group extends Model {}

  Group.init(
    {
      name: {
        type: DataTypes.STRING,
        unique: true,
        validate: { notEmpty: { msg: &#34;Group name must not be empty&#34; } },
      },
      // añadimos el nuevo campo
      score: {
        type: DataTypes.INTEGER,
        defaultValue: 0
      }
    },
    {
      sequelize,
    }
  );

  return Group;
};
</code></pre></div><p>Ahora podemos almacenar en la BBDD la puntuación de cada grupo. Para ello modificaremos <code>groupPlay</code> para ello.</p><h2 id=creación-del-controllador>Creación del controllador<a href=#creación-del-controllador class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Crearemos un nuevo archivo <code>controllers/score.js</code> para este fin e implementaremos el método index.</p><div class=collapsable-code><input id=426389175 type=checkbox>
<label for=426389175><span class=collapsable-code__language>js</span>
<span class=collapsable-code__title>controllers/score.js</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-js><code>
const Sequelize = require(&#34;sequelize&#34;);
const Op = Sequelize.Op;
const { models } = require(&#34;../models&#34;)

[...]

// GET /index
exports.index = async (req, res, next) =&gt; {
  try {
    const groups = await models.Group.findAll();
    res.render(&#34;scores/index.ejs&#34;, {
      groups,
    });
  } catch (error) {
    next(error);
  }
};
</code></pre></div><p>Se puede ver cómo el código es casi igual al index de groups, y esto es pq al final estamos obteniendo en un array los grupos que hay y sus atributos, entre ellos nombre y puntuación. La diferencia es en el <code>res.render(...)</code> que ahora llamamos a la nueva vista que crearemos.</p><h2 id=implementación-de-la-vista>Implementación de la vista<a href=#implementación-de-la-vista class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Crearemos una nueva vista para ello: <code>views/scores/index.ejs</code> basándonos en el intex de la vista de groups ya hecha.</p><div class=collapsable-code><input id=732198456 type=checkbox>
<label for=732198456><span class=collapsable-code__language>html</span>
<span class=collapsable-code__title>views/scores/index.ejs</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-html><code>
&lt;h1&gt;Scores:&lt;/h1&gt;

&lt;table&gt;
  &lt;% for (var i in groups) { %&gt; &lt;% var group = groups[i]; %&gt;
  &lt;tr&gt;
    &lt;td&gt;
      &lt;a href=&#34;/groups/&lt;%= group.id %&gt;/randomplay&#34;&gt;&lt;%= group.name %&gt;&lt;/a&gt;
    &lt;/td&gt;
    &lt;td&gt;
      &lt;p&gt;&lt;%= group.score %&gt;&lt;/p&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
  &lt;% } %&gt;
&lt;/table&gt;
</code></pre></div><h2 id=modificación-de-groupcheck>Modificación de <code>groupCheck</code><a href=#modificación-de-groupcheck class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Para ir sumando las puntuaciones, modificaremos el controlador de groupCheck. En mi caso lo he llamado randomCheck pero es distinto al de los quizzes individuales porque está en el archivo <code>controllers/group.js</code>.</p><div class=collapsable-code><input id=917328546 type=checkbox>
<label for=917328546><span class=collapsable-code__language>js</span>
<span class=collapsable-code__title>controllers/group.js</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-js><code>
[...]
exports.randomCheck = async (req, res, next) =&gt; {
  const curGroup = req.load.group;
  try {
    req.session.groupsRandomPlay = req.session.groupsRandomPlay || {};
    req.session.groupsRandomPlay[curGroup.id] = req.session.groupsRandomPlay[
      curGroup.id
    ] || {
      resolved: [],
      lastQuizId: 0,
    };

    const answer = req.query.answer || &#34;&#34;;
    const result =
      answer.toLowerCase().trim() === req.load.quiz.answer.toLowerCase().trim();

    if (result) {
      req.session.groupsRandomPlay[curGroup.id].lastQuizId = 0;
      if (
        req.session.groupsRandomPlay[curGroup.id].resolved.indexOf(
          req.load.quiz.id
        ) === -1
      ) {
        req.session.groupsRandomPlay[curGroup.id].resolved.push(
          req.load.quiz.id
        );
      }

      const score = req.session.groupsRandomPlay[curGroup.id].resolved.length;

      // actualizamos el score del group en cuestión
      curGroup = await curGroup.save({fields: [&#34;score&#34;]});

      res.render(&#34;groups/random_result&#34;, {
        group: curGroup,
        result,
        answer,
        score,
      });
    } else {
      const score = req.session.groupsRandomPlay[curGroup.id].resolved.length;
      delete req.session.groupsRandomPlay[curGroup.id];
      res.render(&#34;groups/random_result&#34;, {
        group: curGroup,
        result,
        answer,
        score,
      });
    }
  } catch (error) {
    next(error);
  }
};
[...]
</code></pre></div><h2 id=adición-del-enlace>Adición del enlace<a href=#adición-del-enlace class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Ahora sólo nos falta añadir el enlace en el menú de navegación.</p><div class=collapsable-code><input id=562794183 type=checkbox>
<label for=562794183><span class=collapsable-code__language>html</span>
<span class=collapsable-code__title>views/scores/index.ejs</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-html><code>
&lt;nav class=&#34;main&#34; id=&#34;mainNav&#34; role=&#34;navigation&#34;&gt;
  &lt;a href=&#34;/&#34;&gt;Home&lt;/a&gt;
  &lt;a href=&#34;/quizzes&#34;&gt;Quizzes&lt;/a&gt;
  &lt;a href=&#34;/author&#34;&gt;Author&lt;/a&gt;
  &lt;a href=&#34;/groups&#34;&gt;Groups&lt;/a&gt;
  &lt;a href=&#34;/scores&#34;&gt;Groups Scores&lt;/a&gt;
  &lt;% if (locals.loginUser) { %&gt;
      &lt;a href=&#34;/users&#34;&gt;Users&lt;/a&gt;
  &lt;% } %&gt;
&lt;/nav&gt;
</code></pre></div><p>Y ya estaría!!!! :)</p></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Marcos Gómez</span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>